<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>折扣</title>
    <link rel="stylesheet" href="/courseorder/css/adminorder.css">
</head>
<style>
    td img {
        width: 100%;
        height: auto;
        max-width: 100px;
    }

    table {
        width: 100%;
        /* 根据需要调整 */
        margin: auto;
        /* 居中表格 */
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #425169;
        /* 与侧边栏接近的颜色 */
        color: #fff;
        /* 文本颜色 */
    }

    /* 表头样式 */
    th {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background-color: #34495e;
        /* 与侧边栏接近的颜色 */
        color: #fff;
        /* 文本颜色 */
        text-align: center;
    }

    /* 单元格样式 */
    td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: center;
        background-color: #fff;
        /* 白色背景 */
        color: #425169;
        /* 与侧边栏接近的颜色 */
    }

    /* 偶数行样式 */
    tbody tr:nth-child(even) {
        background-color: #425169;
        /* 与侧边栏接近的颜色 */
        color: #fff;
        /* 文本颜色 */
    }

    /* 鼠标悬停效果 */
    tbody tr:hover {
        background-color: #34495e;
        /* 与侧边栏接近的颜色 */
        color: #fff;
        /* 文本颜色 */
    }

    .custom-button {
        background-color: #3498db;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
    }

    .custom-button:hover {
        background-color: #2980b9;
    }

    .search {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
    }

    .search button {
        background-color: #3498db;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
    }

    .search button:hover {
        background-color: #2980b9;
    }

    .dialog-button {
        background-color: #3498db;
        /* 蓝色背景 */
        border: none;
        /* 无边框 */
        color: white;
        /* 白色文本 */
        padding: 8px 16px;
        /* 内边距 */
        text-align: center;
        /* 文本居中 */
        text-decoration: none;
        /* 无下划线 */
        font-size: 14px;
        /* 字体大小 */
        border-radius: 4px;
        /* 圆角 */
        cursor: pointer;
        /* 鼠标手形 */
        margin-left: 10px;
        /* 左侧间距 */
    }

    .dialog-button:hover {
        background-color: #2980b9;
        /* 悬停时的背景颜色 */
    }

    dialog input {
        line-height: 1.5;
        /* 行高为 1.5 */
        padding: 4px;
        /* 内边距 */
        border: 1px solid #ccc;
        /* 边框 */
        border-radius: 4px;
        /* 圆角 */
    }

    /* 确保单元格的行高一致 */
    dialog td {
        padding: 10px;
        /* 单元格内边距 */
        line-height: 1.5;
        /* 与输入框相同的行高 */
        text-align: center;
        /* 文本居中 */
    }

    dialog input {
        font-size: 16px;
        /* 字体大小 */
        height: 24px;
        /* 输入框的高度 */
        line-height: 1.5;
        /* 行高 */
        padding: 4px;
        /* 内边距 */
    }

    dialog td {
        padding: 10px;
        line-height: 1.5;
    }
</style>

<body>

    <div id="headder"></div>
    <div class="col-12 col-lg-9">
        <!-- 卡片中放你的功能內容 -->
        <section class="section">
            <div class="card">
                <h3 class="card-header">新增課程資料</h3>
                <div class="card-body"></div>
            </div>
            <div class="content">
                <div class="result">
                    <div class="search">
                        <button class="custom-button" id="add">新增</button>
                    </div>

                    <div class="container">
                        <table align="center" style="width: 70%;">
                            <thead>
                                <tr>
                                    <th>折扣編號</th>
                                    <th>折扣詳情</th>
                                    <th>折扣數量</th>
                                    <th>開始時間</th>
                                    <th>結束時間</th>
                                    <th>修改</th>
                                    <th>刪除</th>
                                </tr>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4>Profile Visit</h4>
                        </div>
                        <div class="card-body">
                            <div id="chart-profile-visit"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>



    <dialog id="insertData">
        <form method="dialog">
            <table align="center" style="width: 70%;">
                <thead>
                    <tr>
                        <th>折扣編號</th>
                        <th>折扣詳情</th>
                        <th>折扣數量</th>
                        <th>開始時間</th>
                        <th>結束時間</th>

                    </tr>
                </thead>

                <tbody>
                    <tr>
                        <td><input type='text' name='disID' placeholder="輸入折扣編號" /></td>
                        <td><input type='text' name='disInfo' placeholder="輸入折扣詳情" /></td>
                        <td><input type='text' name='disPercent' placeholder="輸入折扣數量" /></td>
                        <td><input type='date' name='startDate' /></td>
                        <td><input type='date' name='endDate' /></td>
                    </tr>
                <tfoot>
                    <tr>
                        <td colspan="5" style="text-align: right;">
                            <button class='dialog-button close' id="close" type="reset">取消</button>
                            <button class='dialog-button insert' id='insert' type="submit">確定</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </form>
    </dialog>
</body>
<script>

    window.onload = () => {
        const discount = sessionStorage.getItem("discount");
        if (discount) {
            appendDiscount(JSON.parse(discount));
        } else {
            allDisscount();
        }
    }

    function allDisscount() {
        fetch("/coursediscount")
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
            }).then(data => {
                let discount = JSON.stringify(data);
                sessionStorage.setItem("discount", discount)
                appendDiscount(data);
            })
    }

    function appendDiscount(data) {
        let tbody = document.querySelector("tbody");
        tbody.innerHTML = "";
        for (let key in data) {
            let tr = document.createElement("tr");
            let startDate = new Date(data[key].startDate)
            let endDate = new Date(data[key].endDate)
            let startM = (startDate.getMonth() + 1) < 10 ? "0" + (startDate.getMonth() + 1) : (startDate.getMonth() + 1);
            let startD = startDate.getDate() < 10 ? "0" + startDate.getDate() : startDate.getDate();
            let endM = (endDate.getMonth() + 1) < 10 ? "0" + (endDate.getMonth() + 1) : (endDate.getMonth() + 1);
            let endD = endDate.getDate() < 10 ? "0" + endDate.getDate() : endDate.getDate();
            tr.innerHTML =
                "<td class='disID'>" + data[key].disID + "</td>" +
                "<td>" + data[key].disInfo + "</td>" +
                "<td>" + data[key].disPercent + "</td>" +
                "<td>" + startDate.getFullYear() + "-" + startM + "-" + startD + "</td>" +
                "<td>" + endDate.getFullYear() + "-" + endM + "-" + endM + "</td>" +
                "<td><button class='custom-button update' >修改</button></td>" +
                "<td><button class='custom-button delete' >刪除</button></td>";
            tbody.appendChild(tr);
            let deleteBtn = tr.querySelector('.custom-button.delete');
            deleteBtn.addEventListener('click', deleteDis);

            let updateBtn = tr.querySelector('.custom-button.update');
            updateBtn.addEventListener('click', updateDialog);
        }
    }

    let addBtn = document.querySelector("#add");
    let dialog = document.querySelector("#insertData");
    addBtn.addEventListener("click", () => {
        dialog.showModal();
    });

    let closeBtn = document.querySelector("#close");
    closeBtn.addEventListener("click", () => {
        dialog.close();
    })

    let action = "insert";
    let form = document.querySelector("form");
    let insertBtn = document.querySelector("#insert");
    insertBtn.addEventListener('click', function () {
        console.log();
        let input = document.querySelectorAll("dialog tr td input");
        let data = {};
        for (let key of input) {
            data[key.name] = key.value;
        }
        console.log(JSON.stringify(data));
        console.log(data["disID"])
        if (action == "insert") {
            insertDis(data);
        } else {
            updateDis(data);
        }
        form.reset();
        dialog.close();
    })

    function insertDis(data) {
        fetch("/coursediscount", {
            method: "post",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(response => {
            if (response.ok) {
                allDisscount();
            }
        }).catch(error => {
            console.log("????");
        })
    }

    function deleteDis(e) {
        let tr = e.target.closest("tr");
        let disID = tr.querySelector(".disID").innerText;
        console.log("删除的折扣 ID:", disID);
        fetch("/coursediscount/" + disID, {
            method: "delete"
        }).then(response => {
            if (response.ok) {
                allDisscount();
            }
        })
    }

    function updateDialog(e) {
        let tr = e.target.closest("tr");
        console.log(tr);
        let td = tr.querySelectorAll("td");
        let dialog = document.querySelector("dialog");
        let input = dialog.querySelectorAll("input");
        for (let i = 0; i < 5; i++) {
            console.log(td[i].innerText);
            input[i].value = td[i].innerText;
        }
        action = "update";
        dialog.showModal();
    }

    function updateDis(data) {
        fetch("/coursediscount", {
            method: "put",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(response => {
            if (response.ok) {
                allDisscount();
            }
        })
    }



    function addDiscount() {
        let tbody = document.querySelector("tbody");
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td><input type='text' name='disID' placeholder="輸入折扣編號"  /></td>
            <td><input type='text' name='disInfo' placeholder="輸入折扣詳情" /></td>
            <td><input type='text' name='disPercent' placeholder="輸入折扣數量" /></td>
            <td><input type='date' name='startDate' /></td>
            <td><input type='date' name='endDate' /></td>
            <td><button class='custom-button cancel' onclick='cancel(this)'>取消</button></td>
            <td><button class='custom-button' id='insert'>確定</button></td>
        `
        tbody.append(tr);
        addBtn.disabled = true;

    }

    fetch('/dist/demo.html')
        .then(response => response.text())
        .then(data => {
            document.querySelector('#headder').innerHTML = data;
        })
        .catch(error => console.error('頁首內容加載錯誤:', error));
</script>

</html>