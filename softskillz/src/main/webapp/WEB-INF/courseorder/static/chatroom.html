<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<title>聊天室</title>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<style type="text/css">
		input {
			width: 150px;
			height: 30px;
			line-height: 25px;
			padding: 5px 10px;
			border-radius: 5px;
			border: 2px solid;
			font-size: 16px;
		}

		#msg {
			width: 300px;
		}

		button {
			width: 80px;
			height: 44px;
			padding: 5px 20px;
			border-radius: 5px;
		}
	</style>
</head>

<body>
	聊天室<br /><br />
	<input type="text" id="sendOutUser" placeholder="自己的用户名" />
	<button onclick="connectWebSocket()">上线</button>
	<button onclick="closeWebSocket()">下线</button>
	<!-- 显示未读消息的计数 -->

	<br /><br />
	<input type="text" id="msg" placeholder="要发送的信息" />
	<input type="text" id="receiveUser" placeholder="接收人的用户名" />
	<button onclick="send()">发送</button>
	<button>高</button>
	<br /><br />
	<hr />
	<div id="msgList"></div>

	<script type="text/javascript">
		var websocket = null;

		function connectWebSocket() {
			var sendOutUser = document.getElementById("sendOutUser").value;

			if (sendOutUser === "") {
				alert("请输入用户名");
				return;
			}

			// 创建 WebSocket 连接
			if ('WebSocket' in window) {
				websocket = new WebSocket("ws://localhost:8080/web-socket/" + sendOutUser);
			} else {
				alert("当前浏览器不支持 WebSocket");
				return;
			}

			websocket.onerror = function () {
				alert("连接发生错误");
			};

			websocket.onopen = function () {
				document.getElementById("sendOutUser").readOnly = true;
				document.getElementById("sendOutUser").style.backgroundColor = '#ddd';
				innerdiv("", "WebSocket 连接已建立");
			};

			websocket.onclose = function () {
				innerdiv("", "WebSocket 连接已关闭");
			};

			websocket.onmessage = function (event) {
				innerdiv("", event.data); // 显示收到的消息
			};

			window.onbeforeunload = function () {
				closeWebSocket(); // 关闭 WebSocket 连接
			};
		}

		function closeWebSocket() {
			if (websocket) {
				websocket.close();
			}
		}

		function send() {
			var sendOutUser = document.getElementById("sendOutUser").value;
			var msg = document.getElementById("msg").value;
			var receiveUser = document.getElementById("receiveUser").value;

			if (msg === "") {
				alert("请输入消息");
				return;
			}

			var chatRoomId = generateChatRoomId(sendOutUser, receiveUser);

			var message = {
				chatRoomId: chatRoomId,
				sendOutUser: sendOutUser,
				receiveUser: receiveUser,
				msg: msg
			};

			websocket.send(JSON.stringify(message)); // 发送消息
			innerdiv("我", msg); // 显示发送的消息
		}

		function resetUnread() {
			unreadCount = 0; // 重置未读消息计数
			updateUnreadCount(); // 更新按钮上的显示
		}

	

		function innerdiv(id, txt) {
			var msgList = document.getElementById("msgList");
			if (id === "") {
				msgList.innerHTML += "<div>" + txt + "</div><br/>";
			} else {
				msgList.innerHTML += "<div>" + id + ": " + txt + "</div><br/>";
			}
		}

		function generateChatRoomId(user1, user2) {
			return user1 < user2 ? user1 + "_" + user2 : user2 + "_" + user1;
		}
	</script>
</body>

</html>